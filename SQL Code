--General Customer Data
SELECT Customer_Status, COUNT(*) AS CUSTOMER_COUNT, SUM(Total_Revenue) AS REVENUE,
(COUNT(CUSTOMER_ID) * 100.0 / SUM(COUNT(CUSTOMER_ID)) OVER()) AS CHURN_PERCENTAGE
FROM customers
GROUP BY Customer_Status
ORDER BY 3 DESC

--Demographics
--Churned Percentage
SELECT GENDER,
	CASE WHEN AGE BETWEEN 18 AND 24 THEN '18-24'
	WHEN AGE BETWEEN 25 AND 34 THEN '25-34'
	WHEN AGE BETWEEN 35 AND 44 THEN '35-44'
	WHEN AGE BETWEEN 45 AND 54 THEN '45-54'
	WHEN AGE BETWEEN 55 AND 65 THEN '55-65'
	WHEN AGE >65 THEN '65+'
END AS AGE_GROUP,
	CASE WHEN Married=1 THEN 'Married'
	WHEN Married=0 THEN 'Single'
END AS MARRIAGE_GROUP,
ROUND(COUNT(CUSTOMER_ID) * 100.0 / SUM(COUNT(CUSTOMER_ID)) OVER(),1) AS CHURN_PERCENTAGE
FROM CUSTOMERS
WHERE Customer_Status='Churned'
GROUP BY Gender,
	CASE WHEN AGE BETWEEN 18 AND 24 THEN '18-24'
	WHEN AGE BETWEEN 25 AND 34 THEN '25-34'
	WHEN AGE BETWEEN 35 AND 44 THEN '35-44'
	WHEN AGE BETWEEN 45 AND 54 THEN '45-54'
	WHEN AGE BETWEEN 55 AND 65 THEN '55-65'
	WHEN AGE >65 THEN '65+'
END,
	CASE WHEN Married=1 THEN 'Married'
	WHEN Married=0 THEN 'Single'
END
ORDER BY 4 DESC

--Joined Percentage
SELECT GENDER,
	CASE WHEN AGE BETWEEN 18 AND 24 THEN '18-24'
	WHEN AGE BETWEEN 25 AND 34 THEN '25-34'
	WHEN AGE BETWEEN 35 AND 44 THEN '35-44'
	WHEN AGE BETWEEN 45 AND 54 THEN '45-54'
	WHEN AGE BETWEEN 55 AND 65 THEN '55-65'
	WHEN AGE >65 THEN '65+'
END AS AGE_GROUP,
	CASE WHEN Married=1 THEN 'Married'
	WHEN Married=0 THEN 'Single'
END AS MARRIAGE_GROUP,
ROUND(COUNT(CUSTOMER_ID) * 100.0 / SUM(COUNT(CUSTOMER_ID)) OVER(),1) AS JOIN_PERCENTAGE
FROM CUSTOMERS
WHERE Customer_Status='Joined'
GROUP BY Gender,
	CASE WHEN AGE BETWEEN 18 AND 24 THEN '18-24'
	WHEN AGE BETWEEN 25 AND 34 THEN '25-34'
	WHEN AGE BETWEEN 35 AND 44 THEN '35-44'
	WHEN AGE BETWEEN 45 AND 54 THEN '45-54'
	WHEN AGE BETWEEN 55 AND 65 THEN '55-65'
	WHEN AGE >65 THEN '65+'
END,
	CASE WHEN Married=1 THEN 'Married'
	WHEN Married=0 THEN 'Single'
END
ORDER BY 4 DESC

--Stayed Percentage
SELECT GENDER,
	CASE WHEN AGE BETWEEN 18 AND 24 THEN '18-24'
	WHEN AGE BETWEEN 25 AND 34 THEN '25-34'
	WHEN AGE BETWEEN 35 AND 44 THEN '35-44'
	WHEN AGE BETWEEN 45 AND 54 THEN '45-54'
	WHEN AGE BETWEEN 55 AND 65 THEN '55-65'
	WHEN AGE >65 THEN '65+'
END AS AGE_GROUP,
	CASE WHEN Married=1 THEN 'Married'
	WHEN Married=0 THEN 'Single'
END AS MARRIAGE_GROUP,
ROUND(COUNT(CUSTOMER_ID) * 100.0 / SUM(COUNT(CUSTOMER_ID)) OVER(),1) AS STAYED_PERCENTAGE
FROM CUSTOMERS
WHERE Customer_Status='Stayed'
	GROUP BY Gender,
	CASE WHEN AGE BETWEEN 18 AND 24 THEN '18-24'
	WHEN AGE BETWEEN 25 AND 34 THEN '25-34'
	WHEN AGE BETWEEN 35 AND 44 THEN '35-44'
	WHEN AGE BETWEEN 45 AND 54 THEN '45-54'
	WHEN AGE BETWEEN 55 AND 65 THEN '55-65'
	WHEN AGE >65 THEN '65+'
END,
	CASE WHEN Married=1 THEN 'Married'
	WHEN Married=0 THEN 'Single'
END
ORDER BY 4 DESC

--Key Churn Drivers
SELECT CHURN_CATEGORY, CHURN_REASON, COUNT(*) AS CHURN_COUNT,
(COUNT(CUSTOMER_ID) * 100.0 / SUM(COUNT(CUSTOMER_ID)) OVER()) AS PERC
FROM CUSTOMERS
WHERE Churn_Reason IS NOT NULL
GROUP BY Churn_Category, Churn_Reason
ORDER BY 3 DESC

--Churn Rate by Offer Type
SELECT OFFER,
(COUNT(CUSTOMER_ID) * 100.0 / SUM(COUNT(CUSTOMER_ID)) OVER()) AS CHURN_PERCENTAGE
FROM customers
WHERE Customer_Status='Churned'
GROUP BY Offer
ORDER BY 2 DESC

--Churn Rate by Contract Type
SELECT Contract,
(COUNT(CUSTOMER_ID) * 100.0 / SUM(COUNT(CUSTOMER_ID)) OVER()) AS CHURN_PERCENTAGE
FROM customers
WHERE Customer_Status='Churned'
GROUP BY Contract
ORDER BY 2 DESC

--Churn Rate by Internet Type
SELECT Internet_Type,
(COUNT(CUSTOMER_ID) * 100.0 / SUM(COUNT(CUSTOMER_ID)) OVER()) AS CHURN_PERCENTAGE
FROM customers
WHERE Customer_Status='Churned'
GROUP BY Internet_Type
ORDER BY 2 DESC

--Tenure Length
SELECT 
	CASE WHEN TENURE_IN_MONTHS BETWEEN 1 AND 6 THEN '6 Months'
	WHEN TENURE_IN_MONTHS BETWEEN 7 AND 12 THEN '1 Year'
	WHEN TENURE_IN_MONTHS BETWEEN 13 AND 24 THEN '2 Years'
	WHEN TENURE_IN_MONTHS BETWEEN 25 AND 36 THEN '3 Years'
	WHEN TENURE_IN_MONTHS BETWEEN 37 AND 48 THEN '4 Years'
	WHEN TENURE_IN_MONTHS BETWEEN 49 AND 60 THEN '5 Years'
	WHEN TENURE_IN_MONTHS BETWEEN 61 AND 72 THEN '6 Years'
	END AS TENURE_LENGHT,
	(COUNT(CUSTOMER_ID) * 100.0 / SUM(COUNT(CUSTOMER_ID)) OVER()) AS CHURN_PERCENTAGE
FROM customers
WHERE Customer_Status='Churned' 
GROUP BY
CASE WHEN TENURE_IN_MONTHS BETWEEN 1 AND 6 THEN '6 Months'
	WHEN TENURE_IN_MONTHS BETWEEN 7 AND 12 THEN '1 Year'
	WHEN TENURE_IN_MONTHS BETWEEN 13 AND 24 THEN '2 Years'
	WHEN TENURE_IN_MONTHS BETWEEN 25 AND 36 THEN '3 Years'
	WHEN TENURE_IN_MONTHS BETWEEN 37 AND 48 THEN '4 Years'
	WHEN TENURE_IN_MONTHS BETWEEN 49 AND 60 THEN '5 Years'
	WHEN TENURE_IN_MONTHS BETWEEN 61 AND 72 THEN '6 Years'
	END
	ORDER BY 2 DESC
